# local variable
set -g @config_root "$HOME/.dotfiles/user/apps/terminal/tmux"
set -g @scripts_root "$HOME/.dotfiles/user/apps/terminal/tmux/scripts"

# general
setw -g xterm-keys on
set -s escape-time 0
set -sg repeat-time 300
set -s focus-events on
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'
set -g mouse on
set -sg exit-empty on
set -g detach-on-destroy off

set -g history-limit 10000

set -g visual-activity off
setw -g monitor-activity off
setw -g monitor-bell off

set-hook -g pane-focus-in "run -b 'bash #{@config_root}/fzf_panes.sh update_mru_pane_ids'"

set -g default-terminal "tmux-256color"
set -as terminal-features ",*256col*:RGB"
set -as terminal-overrides ",*256col*:Tc"




# display
set -g base-index 1
setw -g pane-base-index 1

setw -g automatic-rename off
set -g renumber-windows on

set -g set-titles on

set -g display-panes-time 2000
set -g display-time 2000




set-hook -gu session-created
set-hook -ag session-created 'run -b "#{@scripts_root}/session_created.sh"'
set-hook -ag session-created 'run -b "tmux refresh-client -S"'

set-hook -gu session-renamed
set-hook -g session-renamed 'run -b "tmux refresh-client -S"'

set-hook -gu session-closed
set-hook -g session-closed 'run -b "tmux refresh-client -S"'

run-shell "#{@scripts_root}/session_created.sh"



unbind C-b
set -g prefix M-f
bind M-f send-prefix

# reload configuration
bind r source-file ~/.config/tmux/tmux.conf \; display '~/.config/tmux/tmux.conf sourced'

# session related
unbind N
bind N run-shell "#{@scripts_root}/new_session.sh"
bind -n M-o break-pane
bind . command-prompt -p "Rename session to:" "run-shell \"#{@scripts_root}/rename_session_prompt.sh '%%'\""
unbind ,
bind , command-prompt -p "Rename window:" "rename-window '%%'"

# detach
bind q detach-client

# window related
bind n new-window -c "#{pane_current_path}"
bind d kill-pane
bind D confirm-before -p "Kill window #W? (y/n)" kill-window

bind -n C-M-S-h swap-window -t :-
bind -n C-M-S-l swap-window -t :+

bind -n C-M-h previous-window
bind -n C-M-l next-window


bind ! join-pane -t :1
bind @ join-pane -t :2
bind '#' join-pane -t :3
bind '$' join-pane -t :4
bind % join-pane -t :5
bind ^ join-pane -t :6
bind & join-pane -t :7
bind * join-pane -t :8
bind ( join-pane -t :9



bind K split-window -vb -c "#{pane_current_path}"
bind J  split-window -v -c "#{pane_current_path}"
bind H split-window -hb -c "#{pane_current_path}"
bind L split-window -h -c "#{pane_current_path}"


bind BSpace resize-pane -Z

unbind h
unbind l
unbind j
unbind k
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind Space run-shell "#{@scripts_root}/toggle_orientation.sh"


bind -r < swap-pane -D
bind -r > swap-pane -U


bind b choose-tree -Z
bind i choose-tree 'move-pane -v -s "%%"'
bind I choose-tree 'move-pane -h -s "%%"'

# pane resizing
bind -n M-h resize-pane -L 3
bind -n M-j resize-pane -D 3
bind -n M-k resize-pane -U 3
bind -n M-l resize-pane -R 3


set -g status-keys emacs
set -g mode-keys vi

bind v copy-mode

bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel

bind -n C-M-S-k run-shell "#{@scripts_root}/move_session.sh left"
bind -n C-M-S-j run-shell "#{@scripts_root}/move_session.sh right"

bind -n C-M-k run-shell -b "#{@scripts_root}/switch_session.sh left"
bind -n C-M-j run-shell -b "#{@scripts_root}/switch_session.sh right"

bind M-L run-shell "#{@scripts_root}/layout_builder.sh right"
bind M-H run-shell "#{@scripts_root}/layout_builder.sh left"
bind M-K run-shell "#{@scripts_root}/layout_builder.sh up"
bind M-J run-shell "#{@scripts_root}/layout_builder.sh down"


# plugins
# merge tmux with nvim lualine
set -g focus-events on
set -g status-style bg=default
# set -g status-left '#(cat #{socket_path}-\#{session_id}-vimbridge)'
set -g status-left-length 99
# set -g status-right '#(cat #{socket_path}-\#{session_id}-vimbridge-R)'
set -g status-right-length 99
set -g status-justify centre

# simple auto window naming
# Ensure script is executable (in case repo perms differ)
run-shell "chmod +x #{@scripts_root}/rename_windows_simple.sh 2>/dev/null || true"

# Icon style: name | icon | name_and_icon
# We want: ICON + directory
set -g @swn_icon_style 'icon'
# Max name length (default 15 in script)
set -g @swn_max_len '15'
# Example custom overrides (format: cmd=ICON,cmd2=ICON2)
# set -g @swn_custom_icons 'python=ðŸ,custom_app=ðŸ“¦'

# Trigger on common window/pane lifecycle events and once at load
# set-hook -g before-select-window[swn] "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
# set-hook -g after-select-window[swn]  "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
# set-hook -g pane-focus-in[swn]        "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
# set-hook -g after-new-window[swn]     "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
# set-hook -g after-split-window[swn]   "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
# set-hook -g pane-exited[swn]          "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
# set-hook -g before-select-window "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
set-hook -g after-select-window  "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
set-hook -g pane-focus-in        "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
set-hook -g after-new-window     "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
set-hook -g after-split-window   "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"
set-hook -g pane-exited          "run-shell -b '#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1'"

run-shell -b "#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1"

# Manual trigger: Alt-r (global)
bind -n M-r run-shell -b "#{@scripts_root}/rename_windows_simple.sh >/dev/null 2>&1"
